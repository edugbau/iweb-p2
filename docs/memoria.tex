\documentclass[12pt,a4paper]{article}

% Paquetes
\usepackage[utf8]{inputenc}
\usepackage[spanish]{babel}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{geometry}
\usepackage{fancyhdr}
\usepackage{enumitem}
\usepackage{booktabs}
\usepackage{float}
\usepackage{longtable}
\usepackage{amssymb}

% Configuración de márgenes
\geometry{
    a4paper,
    left=2.5cm,
    right=2.5cm,
    top=3cm,
    bottom=3cm
}

% Configuración de encabezados
\pagestyle{fancy}
\fancyhf{}
\rhead{Parcial 3 - Ingeniería Web 2024/25}
\lhead{ReViews - Memoria Técnica}
\cfoot{\thepage}
\setlength{\headheight}{15pt}

% Configuración de código
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2,
    frame=single,
    extendedchars=true,
    inputencoding=utf8,
    literate={á}{{\'a}}1 {é}{{\'e}}1 {í}{{\'i}}1 {ó}{{\'o}}1 {ú}{{\'u}}1
             {Á}{{\'A}}1 {É}{{\'E}}1 {Í}{{\'I}}1 {Ó}{{\'O}}1 {Ú}{{\'U}}1
             {ñ}{{\~n}}1 {Ñ}{{\~N}}1 {ü}{{\"u}}1 {Ü}{{\"U}}1
             {€}{{\texteuro}}1 {£}{{\pounds}}1
             {→}{{$\rightarrow$}}1 {←}{{$\leftarrow$}}1
}

\lstset{style=mystyle}

% Sin etiqueta "Listing"
\renewcommand{\lstlistingname}{}

% Información del documento
\title{
    \vspace{-1cm}
    \texorpdfstring{\textbf{Parcial 3 - Ingeniería Web 2024/25}}{\textbf{Parcial 3 - Ingeniería Web 2024/25}} \\[0.5cm]
    \Large{ReViews - Aplicación Web de Reseñas de Establecimientos}\\[0.3cm]
    \large{Mapas, OAuth 2.0, Imágenes y Geocodificación}
}
\author{
    \textbf{Nombre del Alumno}\\[0.2cm]
    Universidad de Málaga\\
    Escuela Técnica Superior de Ingeniería Informática\\[0.2cm]
    Asignatura: Ingeniería Web\\
    Fecha: \today
}
\date{}

\begin{document}

\maketitle
\thispagestyle{empty}

\newpage
\tableofcontents
\newpage

% ============================================
% SECCIÓN 1: DESPLIEGUE EN LA NUBE
% ============================================
\section{URL de Despliegue en la Nube}

La aplicación \textbf{ReViews} ha sido desplegada en servicios cloud públicos, separando frontend y backend:

\subsection{URLs de Acceso}

\begin{table}[H]
\centering
\begin{tabular}{@{}ll@{}}
\toprule
\textbf{Servicio} & \textbf{URL} \\ \midrule
Repositorio GitHub & \url{https://github.com/edugbau/iweb-p2} \\
Frontend (Vercel) & \url{https://iweb-p2.vercel.app} \\
Backend API (Render) & \url{https://iweb-p2.onrender.com} \\
Documentación Swagger & \url{https://iweb-p2.onrender.com/docs} \\
Documentación ReDoc & \url{https://iweb-p2.onrender.com/redoc} \\
OpenAPI JSON & \url{https://iweb-p2.onrender.com/openapi.json} \\ \bottomrule
\end{tabular}
\caption{URLs de acceso a la aplicación desplegada}
\end{table}

\subsection{Consideraciones sobre Render (Plan Gratuito)}

\textbf{Importante}: Render, en su plan gratuito, suspende automáticamente el servicio tras 15 minutos de inactividad. Esto significa que:

\begin{itemize}
    \item La primera petición tras el periodo de inactividad puede tardar entre 30-50 segundos en responder.
    \item Se recomienda acceder primero a la URL del backend para ``despertar'' el servicio antes de usar la aplicación.
    \item La aplicación incluye un banner de notificación que avisa al usuario cuando el servidor está iniciándose.
\end{itemize}

% ============================================
% SECCIÓN 2: EMAIL DE PRUEBAS
% ============================================
\section{Email de Pruebas}

Para las pruebas y validación de la aplicación se ha utilizado la siguiente cuenta de Google:

\begin{center}
\fbox{\texttt{tu-email-de-pruebas@gmail.com}}
\end{center}

\textit{Nota: Sustituir por el email real utilizado para las pruebas.}

Este email se utiliza para:
\begin{itemize}
    \item Autenticación mediante Google OAuth 2.0
    \item Creación de reseñas de establecimientos
    \item Asociación de reseñas con el autor
    \item Verificación de permisos (solo el autor puede eliminar sus reseñas)
\end{itemize}

% ============================================
% SECCIÓN 3: TECNOLOGÍAS UTILIZADAS
% ============================================
\section{Tecnologías Utilizadas}

\subsection{Stack Tecnológico Completo}

\subsubsection{Frontend}

\begin{table}[H]
\centering
\begin{tabular}{@{}ll@{}}
\toprule
\textbf{Tecnología} & \textbf{Versión/Detalle} \\ \midrule
Lenguaje & TypeScript 5.0+ \\
Framework & React 18+ \\
Build Tool & Vite 5.x \\
Estilos & TailwindCSS 3.x (Glassmorphism) \\
Iconos & Font Awesome 6.x \\
Mapas & React-Leaflet 4.x + Leaflet 1.9.x \\
HTTP Client & Axios \\
OAuth & @react-oauth/google \\
Arquitectura & Clean Architecture \\ \bottomrule
\end{tabular}
\caption{Tecnologías del Frontend}
\end{table}

\subsubsection{Backend}

\begin{table}[H]
\centering
\begin{tabular}{@{}ll@{}}
\toprule
\textbf{Tecnología} & \textbf{Versión/Detalle} \\ \midrule
Lenguaje & Python 3.11+ \\
Framework Web & FastAPI 0.109+ \\
Driver BD & Motor (MongoDB async) \\
Validación & Pydantic V2 \\
Servidor ASGI & Uvicorn \\
OAuth & google-auth \\
Imágenes & Cloudinary Python SDK \\
Geocoding & Nominatim (OpenStreetMap) \\
JWT & python-jose \\
Arquitectura & Monolito Modular \\ \bottomrule
\end{tabular}
\caption{Tecnologías del Backend}
\end{table}

\subsubsection{Base de Datos}

\begin{itemize}
    \item \textbf{Tipo}: NoSQL (Orientada a documentos)
    \item \textbf{Motor}: MongoDB 7.x
    \item \textbf{Proveedor}: MongoDB Atlas (Cloud)
    \item \textbf{Plan}: M0 (Free Tier - 512 MB)
    \item \textbf{Colección principal}: \texttt{reviews}
\end{itemize}

\subsubsection{Servicios Externos}

\begin{table}[H]
\centering
\begin{tabular}{@{}lll@{}}
\toprule
\textbf{Servicio} & \textbf{Proveedor} & \textbf{Uso} \\ \midrule
Mapas & OpenStreetMap & Visualización de mapas \\
Geocoding & Nominatim + Photon + Geocode.maps.co & Conversión dirección $\rightarrow$ coordenadas \\
Imágenes & Cloudinary & Almacenamiento cloud de fotos \\
OAuth 2.0 & Google Identity & Autenticación de usuarios \\ \bottomrule
\end{tabular}
\caption{Servicios externos utilizados}
\end{table}

\subsubsection{Despliegue}

\begin{table}[H]
\centering
\begin{tabular}{@{}ll@{}}
\toprule
\textbf{Componente} & \textbf{Proveedor} \\ \midrule
Frontend & Vercel (Plan Free) \\
Backend & Render (Plan Free) \\
Base de datos & MongoDB Atlas (Plan M0 Free) \\
Contenedores & Docker + Docker Compose \\ \bottomrule
\end{tabular}
\caption{Proveedores de despliegue}
\end{table}

\subsection{Arquitectura del Sistema}

\subsubsection{Frontend - Clean Architecture}

El frontend sigue estrictamente los principios de Clean Architecture:

\begin{lstlisting}[language=bash, caption=Estructura del Frontend]
src/
+-- domain/              # Capa de Dominio (sin dependencias externas)
|   +-- models/          # Interfaces TypeScript puras
|   |   +-- Review.ts    # Review_Model, Review_Create_Data
|   +-- repositories/    # Contratos de repositorio
|       +-- ReviewRepository.ts
+-- infrastructure/      # Capa de Infraestructura
|   +-- api/
|   |   +-- axios_client.ts  # Cliente HTTP configurado
|   +-- repositories/
|       +-- HttpReviewRepository.ts  # Implementacion HTTP
+-- presentation/        # Capa de Presentacion
|   +-- components/      # Componentes reutilizables
|   |   +-- ReviewCard.tsx
|   |   +-- ReviewDetail.tsx
|   |   +-- ReviewForm.tsx
|   |   +-- StarRating.tsx
|   |   +-- MapComponent.tsx
|   |   +-- LoginButton.tsx
|   +-- pages/           # Paginas completas
|   |   +-- LoginPage.tsx
|   |   +-- ReviewsPage.tsx
|   +-- hooks/           # Custom Hooks (Use Cases)
|   |   +-- use_reviews.ts
|   +-- context/         # Estado global
|   |   +-- AuthContext.tsx
|   +-- router/
|       +-- AppRouter.tsx
\end{lstlisting}

\textbf{Principios aplicados}:
\begin{itemize}
    \item La capa de \textbf{Dominio} no tiene dependencias externas (no importa Axios ni React).
    \item Los \textbf{Componentes UI} no hacen llamadas API directamente, usan hooks.
    \item Los \textbf{Hooks} (Application Layer) encapsulan la lógica de negocio.
    \item La \textbf{Infraestructura} implementa los contratos definidos en el dominio.
\end{itemize}

\subsubsection{Backend - Monolito Modular}

El backend sigue una arquitectura en capas:

\begin{lstlisting}[language=bash, caption=Estructura del Backend]
app/backend/
+-- api/v1/
|   +-- router.py            # Router principal
|   +-- endpoints/
|       +-- auth.py          # Endpoints de autenticacion
|       +-- reviews.py       # CRUD de resenas
+-- core/
|   +-- config.py            # Configuracion (Settings)
|   +-- database.py          # Conexion MongoDB
+-- models/
|   +-- review.py            # Modelo MongoDB (ReviewModel)
+-- schemas/
|   +-- auth.py              # Schemas de autenticacion
|   +-- review.py            # Schemas de resenas (Pydantic V2)
|   +-- common.py            # Schemas comunes
+-- repositories/
|   +-- review_repository.py # Acceso a datos
+-- services/
|   +-- auth_service.py      # Logica de OAuth/JWT
|   +-- image_service.py     # Subida a Cloudinary
|   +-- map_service.py       # Geocodificacion
+-- main.py                  # Punto de entrada FastAPI
\end{lstlisting}

% ============================================
% SECCIÓN 4: INSTALACIÓN Y DESPLIEGUE
% ============================================
\section{Instrucciones de Instalación y Despliegue}

\subsection{Requisitos Previos}

\begin{itemize}
    \item Docker y Docker Compose instalados
    \item Node.js 18+ (opcional, solo si se ejecuta sin Docker)
    \item Python 3.11+ (opcional, solo si se ejecuta sin Docker)
    \item Cuenta de MongoDB Atlas configurada
    \item Cuenta de Cloudinary con credenciales activas
    \item Proyecto de Google Cloud con OAuth 2.0 configurado
\end{itemize}

\subsection{Obtención de Credenciales}

\subsubsection{MongoDB Atlas}
\begin{enumerate}
    \item Ir a \url{https://www.mongodb.com/cloud/atlas}
    \item Crear cuenta y clúster gratuito (M0)
    \item En \textbf{Database Access}, crear usuario y contraseña
    \item En \textbf{Network Access}, permitir acceso desde cualquier IP (\texttt{0.0.0.0/0})
    \item Copiar la Connection String desde \textbf{Database} $\rightarrow$ \textbf{Connect}
\end{enumerate}

\subsubsection{Cloudinary}
\begin{enumerate}
    \item Registrarse en \url{https://cloudinary.com}
    \item En el Dashboard, copiar: \texttt{Cloud Name}, \texttt{API Key}, \texttt{API Secret}
\end{enumerate}

\subsubsection{Google OAuth}
\begin{enumerate}
    \item Ir a \url{https://console.cloud.google.com}
    \item Crear nuevo proyecto
    \item \textbf{APIs \& Services} $\rightarrow$ \textbf{OAuth consent screen} $\rightarrow$ External
    \item \textbf{Credentials} $\rightarrow$ \textbf{Create OAuth client ID} $\rightarrow$ Web application
    \item Añadir orígenes autorizados: \texttt{http://localhost:5173}
    \item Copiar \texttt{Client ID} y \texttt{Client Secret}
\end{enumerate}

\subsection{Configuración de Variables de Entorno}

\subsubsection{Backend (\texttt{app/backend/.env})}

\begin{lstlisting}[caption=Variables de entorno del Backend]
# Configuracion del Servidor
MONGO_URI=mongodb+srv://eduardo:eduardo@cluster0.n63md1g.mongodb.net/?appName=Cluster0
DATABASE_NAME=plantilla
API_NAME=IWEB Exam API

# Cloudinary (Imagenes)
CLOUDINARY_CLOUD_NAME=dhvhzdfwh
CLOUDINARY_API_KEY=682229474789636
CLOUDINARY_API_SECRET=4XDfe2qeDc63g-w6sh87OY4v96U

# Google OAuth (Backend verifica el token)
GOOGLE_CLIENT_ID=1024296056000-rk7006r9ch3fjn85ou47tebu0fla9f8q.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=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

# JWT
SECRET_KEY=secret_key_placeholder_change_me

# Desarrollo local
ALLOWED_ORIGINS=http://localhost:5173
\end{lstlisting}

\subsubsection{Frontend (\texttt{app/frontend/.env})}

\begin{lstlisting}[caption=Variables de entorno del Frontend]
# URL del Backend (Para Axios)
VITE_API_URL=http://localhost:8000/api/v1

# Google OAuth (Para el boton de login en React)
VITE_GOOGLE_CLIENT_ID=1024296056000-rk7006r9ch3fjn85ou47tebu0fla9f8q.apps.googleusercontent.com
\end{lstlisting}

\subsection{Ejecución en Local (con Docker)}

\begin{lstlisting}[language=bash, caption=Comandos para ejecucion local]
# Clonar el repositorio
git clone <url-del-repositorio>
cd iweb-p2

# Crear archivos .env en app/backend/ y app/frontend/
# (copiar las plantillas y rellenar con credenciales)

# Construir y ejecutar con Docker Compose
docker-compose up --build

# O ejecutar en segundo plano
docker-compose up -d --build

# Ver logs en tiempo real
docker-compose logs -f

# Detener los servicios
docker-compose down
\end{lstlisting}

\subsubsection{Acceso a la Aplicación Local}

\begin{table}[H]
\centering
\begin{tabular}{@{}ll@{}}
\toprule
\textbf{Servicio} & \textbf{URL} \\ \midrule
Frontend & \url{http://localhost:5173} \\
Backend API & \url{http://localhost:8000} \\
Swagger UI & \url{http://localhost:8000/docs} \\
ReDoc & \url{http://localhost:8000/redoc} \\ \bottomrule
\end{tabular}
\caption{URLs de acceso local}
\end{table}

\subsection{Despliegue en la Nube}

\subsubsection{Backend en Render}

\begin{enumerate}
    \item Crear cuenta en \url{https://render.com}
    \item Crear nuevo \textbf{Web Service} desde repositorio Git
    \item Configurar:
    \begin{itemize}
        \item \textbf{Root Directory}: \texttt{app/backend}
        \item \textbf{Runtime}: Docker
    \end{itemize}
    \item Añadir \textbf{Environment Variables}:
    \begin{itemize}
        \item \texttt{MONGO\_URI}
        \item \texttt{DATABASE\_NAME}
        \item \texttt{CLOUDINARY\_CLOUD\_NAME}
        \item \texttt{CLOUDINARY\_API\_KEY}
        \item \texttt{CLOUDINARY\_API\_SECRET}
        \item \texttt{GOOGLE\_CLIENT\_ID}
        \item \texttt{GOOGLE\_CLIENT\_SECRET}
        \item \texttt{SECRET\_KEY}
    \end{itemize}
    \item Deploy automático al hacer push a main
\end{enumerate}

\subsubsection{Frontend en Vercel}

\begin{enumerate}
    \item Crear cuenta en \url{https://vercel.com}
    \item Importar proyecto desde repositorio Git
    \item Configurar:
    \begin{itemize}
        \item \textbf{Root Directory}: \texttt{app/frontend}
        \item \textbf{Framework Preset}: Vite
    \end{itemize}
    \item Añadir \textbf{Environment Variables}:
    \begin{itemize}
        \item \texttt{VITE\_API\_URL}: URL del backend en Render (ej: \texttt{https://tu-app.onrender.com/api/v1})
        \item \texttt{VITE\_GOOGLE\_CLIENT\_ID}: Client ID de Google
    \end{itemize}
    \item \textbf{Importante}: Actualizar Google Cloud Console añadiendo el dominio de Vercel a:
    \begin{itemize}
        \item Authorized JavaScript origins
        \item Authorized redirect URIs
    \end{itemize}
\end{enumerate}

% ============================================
% SECCIÓN 5: CONFIGURACIÓN DEL PROYECTO
% ============================================
\section{Configuración del Proyecto}

A continuación se detallan las variables de entorno utilizadas en el proyecto para su correcto funcionamiento.

\subsection{Variables de Entorno del Backend}

El archivo \texttt{app/backend/.env} contiene la siguiente configuración:

\begin{lstlisting}[caption=Configuracion del Backend (.env)]
# Configuracion del Servidor
MONGO_URI=mongodb+srv://eduardo:eduardo@cluster0.n63md1g.mongodb.net/?appName=Cluster0
DATABASE_NAME=plantilla
API_NAME=IWEB Exam API

# Cloudinary (Imagenes)
CLOUDINARY_CLOUD_NAME=dhvhzdfwh
CLOUDINARY_API_KEY=682229474789636
CLOUDINARY_API_SECRET=4XDfe2qeDc63g-w6sh87OY4v96U

# Google OAuth (Backend verifica el token)
GOOGLE_CLIENT_ID=1024296056000-rk7006r9ch3fjn85ou47tebu0fla9f8q.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=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

# JWT
SECRET_KEY=secret_key_placeholder_change_me

# Desarrollo local
ALLOWED_ORIGINS=http://localhost:5173
\end{lstlisting}

\subsection{Variables de Entorno del Frontend}

El archivo \texttt{app/frontend/.env} contiene la siguiente configuración:

\begin{lstlisting}[caption=Configuracion del Frontend (.env)]
# URL del Backend (Para Axios)
VITE_API_URL=http://localhost:8000/api/v1

# Google OAuth (Para el boton de login en React)
VITE_GOOGLE_CLIENT_ID=1024296056000-rk7006r9ch3fjn85ou47tebu0fla9f8q.apps.googleusercontent.com
\end{lstlisting}

\subsection{Resumen de Credenciales}

\begin{table}[H]
\centering
\begin{tabular}{@{}lll@{}}
\toprule
\textbf{Servicio} & \textbf{Parámetro} & \textbf{Valor} \\ \midrule
MongoDB Atlas & Usuario & eduardo \\
MongoDB Atlas & Clúster & cluster0.n63md1g.mongodb.net \\
MongoDB Atlas & Base de datos & plantilla \\
Cloudinary & Cloud Name & dhvhzdfwh \\
Cloudinary & API Key & 682229474789636 \\
Google OAuth & Client ID & 1024296056000-rk7006r9ch3fjn85ou47tebu0fla9f8q \\ \bottomrule
\end{tabular}
\caption{Resumen de credenciales de servicios}
\end{table}

% ============================================
% SECCIÓN 6: BASE DE DATOS
% ============================================
\section{Credenciales de Acceso a la Base de Datos}

Para verificar el contenido de la base de datos MongoDB Atlas:

\begin{table}[H]
\centering
\begin{tabular}{@{}ll@{}}
\toprule
\textbf{Parámetro} & \textbf{Valor} \\ \midrule
Proveedor & MongoDB Atlas \\
Clúster & cluster0.n63md1g.mongodb.net \\
Base de datos & \texttt{plantilla} \\
Colección principal & \texttt{reviews} \\
URI de conexión & \texttt{mongodb+srv://eduardo:eduardo@cluster0.n63md1g.mongodb.net/} \\
Usuario & \texttt{eduardo} \\
Contraseña & \texttt{eduardo} \\ \bottomrule
\end{tabular}
\caption{Credenciales de MongoDB Atlas}
\end{table}

\textit{Nota: Se recomienda crear un usuario de solo lectura específico para el corrector.}

\subsection{Estructura de Documentos}

\begin{lstlisting}[caption=Estructura de documento Review en MongoDB]
{
    "_id": ObjectId("..."),
    "establishment_name": "Casa Lola",
    "address": "Calle Granada 46, Malaga, Espana",
    "latitude": 36.7213028,
    "longitude": -4.4214089,
    "rating": 4,
    "image_urls": [
        "https://res.cloudinary.com/xxx/image/upload/v123/abc.jpg",
        "https://res.cloudinary.com/xxx/image/upload/v123/def.jpg"
    ],
    "author_email": "usuario@gmail.com",
    "author_name": "Juan Garcia",
    "auth_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "created_at": ISODate("2024-12-12T10:30:00.000Z"),
    "expires_at": ISODate("2024-12-13T10:30:00.000Z")
}
\end{lstlisting}

% ============================================
% SECCIÓN 7: FUNCIONALIDAD IMPLEMENTADA
% ============================================
\section{Funcionalidad Implementada}

\subsection{Resumen de Requisitos}

\begin{table}[H]
\centering
\begin{tabular}{@{}lcp{7cm}@{}}
\toprule
\textbf{Requisito} & \textbf{Pts} & \textbf{Estado} \\ \midrule
Identificación OAuth & 2 & $\checkmark$ Login/Logout con Google OAuth 2.0 \\
Mapas y Geocoding & 2 & $\checkmark$ Mapa con marcadores + búsqueda + geocodificación automática \\
Imágenes & 2 & $\checkmark$ Subida múltiple a Cloudinary (hasta 5 por reseña) \\
Listado/Detalle & 2 & $\checkmark$ Lista de reseñas con toda la información requerida \\
Despliegue y Entrega & 2 & $\checkmark$ Vercel + Render + Memoria técnica \\ \midrule
\textbf{Total} & \textbf{10} & \textbf{Todos los requisitos implementados} \\ \bottomrule
\end{tabular}
\caption{Estado de implementación de requisitos}
\end{table}

\subsection{Identificación OAuth (2 puntos)}

\textbf{Funcionalidades implementadas}:

\begin{itemize}
    \item \textbf{Login con Google}: Botón de ``Sign in with Google'' usando \texttt{@react-oauth/google}.
    \item \textbf{Verificación de token}: El backend verifica el token de Google y genera un JWT de sesión.
    \item \textbf{Logout}: Limpieza de tokens del localStorage y estado de React Context.
    \item \textbf{Persistencia de sesión}: El token JWT se almacena en localStorage y se restaura al recargar.
    \item \textbf{Protección de rutas}: Las rutas protegidas redirigen a login si no hay sesión.
    \item \textbf{Header de usuario}: Muestra foto y nombre del usuario autenticado.
\end{itemize}

\textbf{Archivos principales}:
\begin{itemize}
    \item \texttt{frontend/src/presentation/components/LoginButton.tsx}
    \item \texttt{frontend/src/presentation/context/AuthContext.tsx}
    \item \texttt{backend/services/auth\_service.py}
    \item \texttt{backend/api/v1/endpoints/auth.py}
\end{itemize}

\subsection{Mapas y Geocoding (2 puntos)}

\textbf{Funcionalidades implementadas}:

\begin{itemize}
    \item \textbf{Mapa interactivo}: Visualización con React-Leaflet y tiles de OpenStreetMap.
    \item \textbf{Marcadores de reseñas}: Cada reseña se muestra como marcador con popup informativo.
    \item \textbf{Popups}: Muestran imagen, nombre, valoración y botón ``Ver detalle''.
    \item \textbf{Barra de búsqueda}: Permite buscar direcciones y centrar el mapa en ellas.
    \item \textbf{Geocodificación automática}: Al crear reseña, la dirección se convierte a coordenadas GPS usando Nominatim.
    \item \textbf{Toggle vistas}: Botones para cambiar entre vista lista y vista mapa.
\end{itemize}

\textbf{Archivos principales}:
\begin{itemize}
    \item \texttt{frontend/src/presentation/components/MapComponent.tsx}
    \item \texttt{backend/services/map\_service.py}
    \item \texttt{backend/api/v1/endpoints/reviews.py} (endpoint \texttt{POST /geocode})
\end{itemize}

\subsection{Imágenes (2 puntos)}

\textbf{Funcionalidades implementadas}:

\begin{itemize}
    \item \textbf{Subida múltiple}: Se pueden subir hasta 5 imágenes por reseña.
    \item \textbf{Almacenamiento cloud}: Las imágenes se suben a Cloudinary, almacenando las URLs en MongoDB.
    \item \textbf{Formatos soportados}: JPEG, PNG, WebP.
    \item \textbf{Previsualización}: Las imágenes seleccionadas se muestran antes de enviar.
    \item \textbf{Eliminación}: Botón para quitar imágenes de la selección.
    \item \textbf{Galería navegable}: En el detalle, galería con botones anterior/siguiente y dots de navegación.
    \item \textbf{Indicador de cantidad}: Badge mostrando número de imágenes adicionales en las tarjetas.
\end{itemize}

\textbf{Archivos principales}:
\begin{itemize}
    \item \texttt{frontend/src/presentation/components/ReviewForm.tsx}
    \item \texttt{frontend/src/presentation/components/ReviewDetail.tsx}
    \item \texttt{backend/services/image\_service.py}
\end{itemize}

\subsection{Listado y Detalle de Reseñas (2 puntos)}

\textbf{Funcionalidades implementadas}:

\begin{itemize}
    \item \textbf{Vista de lista}: Grid responsive de tarjetas (ReviewCard) con:
    \begin{itemize}
        \item Imagen principal del establecimiento
        \item Nombre del establecimiento
        \item Valoración con estrellas (0-5)
        \item Dirección postal
        \item Coordenadas GPS (latitud, longitud)
        \item Nombre/email del autor
        \item Fecha de creación
    \end{itemize}
    
    \item \textbf{Vista de detalle} (modal ReviewDetail) con información adicional:
    \begin{itemize}
        \item Galería de todas las imágenes
        \item Email completo del autor
        \item Nombre del autor
        \item Fecha y hora de creación
        \item Fecha y hora de caducidad del token
        \item Token OAuth utilizado (completo)
        \item Botón de eliminación (solo visible para el autor)
    \end{itemize}
    
    \item \textbf{Creación de reseñas}: Formulario modal con validación.
    
    \item \textbf{Eliminación}: Solo el autor puede eliminar sus propias reseñas (con confirmación).
\end{itemize}

\textbf{Archivos principales}:
\begin{itemize}
    \item \texttt{frontend/src/presentation/pages/ReviewsPage.tsx}
    \item \texttt{frontend/src/presentation/components/ReviewCard.tsx}
    \item \texttt{frontend/src/presentation/components/ReviewDetail.tsx}
    \item \texttt{frontend/src/presentation/components/ReviewForm.tsx}
    \item \texttt{frontend/src/presentation/components/StarRating.tsx}
\end{itemize}

\subsection{Endpoints de la API}

\begin{table}[H]
\centering
\begin{tabular}{@{}llp{5.5cm}@{}}
\toprule
\textbf{Método} & \textbf{Endpoint} & \textbf{Descripción} \\ \midrule
POST & /api/v1/auth/login & Login con Google OAuth \\
GET & /api/v1/reviews & Listar todas las reseñas \\
GET & /api/v1/reviews/\{id\} & Obtener detalle completo de reseña \\
POST & /api/v1/reviews & Crear nueva reseña (multipart/form-data) \\
DELETE & /api/v1/reviews/\{id\} & Eliminar reseña (solo autor) \\
POST & /api/v1/reviews/geocode & Geocodificar dirección postal \\ \bottomrule
\end{tabular}
\caption{Endpoints de la API REST}
\end{table}

\subsection{Características Técnicas Adicionales}

\begin{itemize}
    \item \textbf{Diseño Glassmorphism}: Interfaz moderna con efectos de cristal, blur y sombras coloreadas.
    \item \textbf{Responsive}: Adaptado a móvil, tablet y escritorio usando TailwindCSS.
    \item \textbf{Accesibilidad}: ARIA labels, navegación por teclado, contraste adecuado.
    \item \textbf{Documentación OpenAPI}: Swagger UI y ReDoc generados automáticamente.
    \item \textbf{Convenciones de código}: \texttt{snake\_case} para variables/funciones.
    \item \textbf{Documentación}: JSDoc en frontend, docstrings en backend (español).
    \item \textbf{Python moderno}: Sintaxis 3.11+ (\texttt{str | None}, \texttt{list[str]}).
    \item \textbf{Pydantic V2}: \texttt{ConfigDict}, \texttt{json\_schema\_extra} para ejemplos.
\end{itemize}

% ============================================
% SECCIÓN 8: LIMITACIONES Y PROBLEMAS
% ============================================
\section{Limitaciones y Problemas Encontrados}

\subsection{Limitaciones Conocidas}

\begin{enumerate}
    \item \textbf{Plan gratuito de Render}: El backend se suspende tras 15 minutos de inactividad, requiriendo 30-50 segundos para ``despertar''.
    
    \item \textbf{Geocodificación (Nominatim)}: API gratuita con límites de tasa. No todas las direcciones se encuentran (depende de la precisión del texto).
    
    \item \textbf{MongoDB Atlas M0}: Límite de 512 MB de almacenamiento.
    
    \item \textbf{Cloudinary Free}: Límite de 25 créditos/mes. Imágenes muy grandes pueden tardar.
    
    \item \textbf{Token JWT}: Expira en 24 horas. No se implementó refresh token automático.
    
    \item \textbf{Imágenes}: Máximo 5 por reseña para no saturar Cloudinary.
\end{enumerate}

\subsection{Problemas Encontrados y Soluciones}

\begin{enumerate}
    \item \textbf{Conexión SSL con MongoDB Atlas}:
    \begin{itemize}
        \item \textit{Problema}: Errores intermitentes \texttt{SSL: UNEXPECTED\_EOF\_WHILE\_READING}.
        \item \textit{Causa}: Configuración de red/firewall, timeout de conexiones idle.
        \item \textit{Solución}: Configuración correcta de TLS en Motor y timeouts adecuados.
    \end{itemize}
    
    \item \textbf{CORS en producción}:
    \begin{itemize}
        \item \textit{Problema}: El frontend en Vercel no podía comunicarse con el backend en Render.
        \item \textit{Solución}: Configurar correctamente los orígenes permitidos en FastAPI CORSMiddleware.
    \end{itemize}
    
    \item \textbf{Iconos de Leaflet con Vite}:
    \begin{itemize}
        \item \textit{Problema}: Los marcadores del mapa no mostraban iconos.
        \item \textit{Solución}: Importar manualmente las imágenes de iconos y configurar \texttt{L.Marker.prototype.options.icon}.
    \end{itemize}
    
    \item \textbf{TypeScript Strict Mode}:
    \begin{itemize}
        \item \textit{Problema}: Error \texttt{TS6196: 'X' is declared but never used}.
        \item \textit{Solución}: Eliminar imports no utilizados para pasar el build de producción.
    \end{itemize}
    
    \item \textbf{Google OAuth en producción}:
    \begin{itemize}
        \item \textit{Problema}: Error de origen no autorizado al desplegar.
        \item \textit{Solución}: Añadir dominios de Vercel a Google Cloud Console (origins y redirects).
    \end{itemize}
\end{enumerate}

% ============================================
% SECCIÓN 9: PROBLEMAS TÉCNICOS DETALLADOS
% ============================================
\section{Problemas Técnicos Detallados}

En esta sección se documentan los problemas técnicos más significativos encontrados durante el desarrollo y despliegue de la aplicación.

\subsection{Problema SSL con MongoDB Atlas en Entorno Local (Docker)}

\subsubsection{Descripción del Problema}

Al ejecutar la aplicación en contenedores Docker en entorno local, se producen errores intermitentes de conexión SSL con MongoDB Atlas:

\begin{lstlisting}[caption=Error SSL en MongoDB Atlas]
pymongo.errors.ServerSelectionTimeoutError: 
SSL handshake failed: ac-nrmtowl-shard-00-01.n63md1g.mongodb.net:27017: 
[SSL: UNEXPECTED_EOF_WHILE_READING] EOF occurred in violation of protocol 
(_ssl.c:1016) (configured timeouts: socketTimeoutMS: 20000.0ms, 
connectTimeoutMS: 20000.0ms)
\end{lstlisting}

\subsubsection{Causa del Problema}

Este error se produce por una combinación de factores:

\begin{enumerate}
    \item \textbf{Configuración de red del contenedor}: Docker utiliza una capa de red virtualizada que puede interferir con las conexiones TLS de larga duración.
    \item \textbf{Firewall/Antivirus}: Algunos antivirus o firewalls (como Windows Defender) inspeccionan el tráfico SSL, causando interrupciones.
    \item \textbf{Timeout de conexiones idle}: MongoDB Atlas cierra conexiones inactivas, y si el driver no maneja bien la reconexión, se produce el error.
    \item \textbf{Versión de OpenSSL en el contenedor}: Incompatibilidades entre la versión de OpenSSL del contenedor y el servidor de MongoDB Atlas.
\end{enumerate}

\subsubsection{Soluciones Implementadas}

\begin{enumerate}
    \item \textbf{Configuración de TLS en la URI de conexión}:
    \begin{lstlisting}[language=Python]
MONGO_URI=mongodb+srv://user:pass@cluster.mongodb.net/
    ?retryWrites=true&w=majority&tls=true
    &tlsAllowInvalidCertificates=false
    \end{lstlisting}
    
    \item \textbf{Configuración de timeouts en Motor}:
    \begin{lstlisting}[language=Python]
client = AsyncIOMotorClient(
    settings.MONGO_URI,
    serverSelectionTimeoutMS=30000,
    connectTimeoutMS=20000,
    socketTimeoutMS=20000,
    maxPoolSize=10,
    minPoolSize=1
)
    \end{lstlisting}
    
    \item \textbf{Nota importante}: Este problema \textbf{no ocurre en producción} (Render), solo en el entorno local con Docker. En Render, la conexión a MongoDB Atlas funciona correctamente sin modificaciones adicionales.
\end{enumerate}

\subsection{Problema con el Servicio de Geocodificación Nominatim}

\subsubsection{Descripción del Problema}

Al intentar geocodificar direcciones desde el backend desplegado en Render, el servicio Nominatim (OpenStreetMap) falla constantemente con errores de conexión:

\begin{lstlisting}[caption=Error de conexion con Nominatim]
[Geocoding] Nominatim connection error: 
All connection attempts failed
\end{lstlisting}

\subsubsection{Causa del Problema}

\begin{enumerate}
    \item \textbf{Bloqueo por IP de datacenter}: Nominatim tiene políticas estrictas de uso que pueden bloquear peticiones desde IPs de servicios cloud conocidos (AWS, Google Cloud, Render, etc.).
    \item \textbf{Rate limiting}: Nominatim limita a 1 petición por segundo y requiere un User-Agent válido.
    \item \textbf{Política de uso aceptable}: El servicio gratuito de Nominatim está pensado para uso ocasional, no para aplicaciones en producción con alto tráfico.
\end{enumerate}

\subsubsection{Soluciones Implementadas}

Se implementó un sistema de \textbf{geocodificación en cascada} con múltiples proveedores de fallback:

\begin{lstlisting}[language=Python, caption=Sistema de geocodificacion con fallbacks]
class GeocodingService:
    # Servicios en orden de prioridad
    NOMINATIM_URL = "https://nominatim.openstreetmap.org/search"
    PHOTON_URL = "https://photon.komoot.io/api/"
    GEOCODE_MAPS_URL = "https://geocode.maps.co/search"
    OPENMETEO_URL = "https://geocoding-api.open-meteo.com/v1/search"
    
    async def get_coordinates(self, address: str):
        # 1. Intentar Nominatim (OpenStreetMap oficial)
        result = await self._try_nominatim(address)
        if result: return result
        
        # 2. Intentar Photon (Komoot, basado en OSM)
        result = await self._try_photon(address)
        if result: return result
        
        # 3. Intentar Geocode.maps.co (alternativa gratuita)
        result = await self._try_geocode_maps(address)
        if result: return result
        
        # 4. Intentar Open-Meteo (sin limites)
        result = await self._try_openmeteo(address)
        if result: return result
        
        # 5. Si todo falla, retornar None
        return None
\end{lstlisting}

\subsubsection{Fallback de Coordenadas por Defecto}

Como último recurso, si todos los servicios de geocodificación fallan, se asignan coordenadas por defecto (Málaga) y se notifica al usuario:

\begin{lstlisting}[language=Python, caption=Coordenadas por defecto como fallback]
DEFAULT_LATITUDE = 36.7213028   # Malaga, Espana
DEFAULT_LONGITUDE = -4.4216366
GEOCODING_WARNING = "No se pudo geocodificar la direccion. 
                     Se han asignado coordenadas por defecto (Malaga)."

@router.post("/geocode")
async def geocode_address(address: str = Form(...)):
    coords = await geocoding_service.get_coordinates(address)
    
    if coords:
        return {"latitude": coords[0], "longitude": coords[1]}
    else:
        # Fallback: coordenadas de Malaga con advertencia
        return {
            "latitude": DEFAULT_LATITUDE,
            "longitude": DEFAULT_LONGITUDE,
            "warning": GEOCODING_WARNING,
            "is_default": True
        }
\end{lstlisting}

\subsubsection{Proveedores de Geocodificación Utilizados}

\begin{table}[H]
\centering
\begin{tabular}{@{}llll@{}}
\toprule
\textbf{Prioridad} & \textbf{Servicio} & \textbf{URL Base} & \textbf{Limitaciones} \\ \midrule
1 & Nominatim & nominatim.openstreetmap.org & 1 req/s, bloqueo IPs cloud \\
2 & Photon & photon.komoot.io & Sin limite documentado \\
3 & Geocode.maps.co & geocode.maps.co & 1 req/s, sin API key \\
4 & Open-Meteo & geocoding-api.open-meteo.com & Sin limite, gratuito \\
5 & Default & -- & Malaga (36.72, -4.42) \\ \bottomrule
\end{tabular}
\caption{Proveedores de geocodificacion en orden de prioridad}
\end{table}

\subsection{Recomendaciones para Producción}

Para un entorno de producción real, se recomienda:

\begin{enumerate}
    \item \textbf{Usar un servicio de geocodificación de pago}: Google Maps Geocoding API, Mapbox, HERE, etc.
    \item \textbf{Implementar caché de geocodificación}: Almacenar resultados en Redis o MongoDB para evitar peticiones repetidas.
    \item \textbf{Usar MongoDB Atlas con plan de pago}: Mejor rendimiento y sin las limitaciones del tier gratuito.
    \item \textbf{Configurar un proxy o VPN}: Para evitar bloqueos de IP en servicios gratuitos.
\end{enumerate}

% ============================================
% SECCIÓN 10: CONCLUSIONES
% ============================================
\section{Conclusiones}

Se ha desarrollado satisfactoriamente \textbf{ReViews}, una aplicación web completa de reseñas de establecimientos que cumple con todos los requisitos especificados en el enunciado del parcial:

\begin{itemize}
    \item[$\checkmark$] \textbf{Autenticación OAuth 2.0} con Google Identity Platform
    \item[$\checkmark$] \textbf{Mapas interactivos} con OpenStreetMap y React-Leaflet
    \item[$\checkmark$] \textbf{Geocodificación automática} de direcciones postales
    \item[$\checkmark$] \textbf{Subida múltiple de imágenes} a Cloudinary
    \item[$\checkmark$] \textbf{CRUD completo} de reseñas con validación
    \item[$\checkmark$] \textbf{Despliegue cloud} en Vercel y Render
    \item[$\checkmark$] \textbf{Arquitectura limpia} y código documentado
    \item[$\checkmark$] \textbf{Diseño responsive} y accesible
\end{itemize}

La aplicación es funcional, estéticamente moderna (estilo Glassmorphism), y sigue las mejores prácticas de desarrollo web contemporáneo, incluyendo Clean Architecture en el frontend y arquitectura modular en el backend.

\end{document}
